import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const USERNAME = 'davies-dev404';
const CONFIG_PATH = path.join(__dirname, '../src/data/projects-config.json');
const OUTPUT_PATH = path.join(__dirname, '../src/data/projects.js');

// Load config
const config = JSON.parse(fs.readFileSync(CONFIG_PATH, 'utf8'));

async function fetchProjects() {
  console.log(`Fetching projects for ${USERNAME}...`);
  const headers = {
    'Accept': 'application/vnd.github.v3+json',
    'User-Agent': 'Portfolio-Updater'
  };

  if (process.env.Git_Token) {
    console.log('Using provided GitHub Token');
    headers['Authorization'] = `token ${process.env.Git_Token}`;
  }

  try {
    // Fetch all repos (pagination support would be good, keeping it simple for now with per_page=100)
    // Note: 'type=all' and authentication allow fetching private repos if the token has scopes
    const response = await fetch(`https://api.github.com/users/${USERNAME}/repos?sort=updated&per_page=100&type=all`, { headers });
    
    if (!response.ok) {
      throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);
    }

    const repos = await response.json();
    console.log(`Found ${repos.length} repositories.`);

    const projects = repos
      .filter(repo => !repo.fork) // Filter out forks unless you want them
      .map((repo, index) => {
        const configData = config[repo.html_url] || config[repo.html_url.replace(/\/$/, "")];
        
        // Determine properties
        const id = index + 1;
        const title = configData?.title || repo.name.replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        const description = repo.description || configData?.description || "No description available.";
        const image = configData?.image || "/assets/placeholder-project.png"; // Fallback image
        const stack = configData?.stack || [repo.language || "code"];
        const github = repo.html_url;
        const demo = repo.homepage || configData?.demo || "";
        const featured = configData?.featured || false;

        return {
          id,
          title,
          description,
          image,
          stack,
          github,
          demo,
          featured
        };
      })
      // Sort: Featured first, then by updated date (which is already roughly the order from API, but let's be sure)
      .sort((a, b) => (b.featured === a.featured ? 0 : b.featured ? 1 : -1));

    // Generate JS content
    const fileContent = `
// This file is auto-generated by scripts/update-projects.js
// Do not edit directly. Update src/data/projects-config.json for custom metadata.

export const projects = ${JSON.stringify(projects, null, 2)};
`;

    fs.writeFileSync(OUTPUT_PATH, fileContent.trim());
    console.log(`Successfully updated ${OUTPUT_PATH} with ${projects.length} projects.`);

  } catch (error) {
    console.error('Failed to fetch projects:', error);
    process.exit(1);
  }
}

fetchProjects();
